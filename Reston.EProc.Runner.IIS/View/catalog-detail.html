<!DOCTYPE html>
<html ng-app="app">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Mandiri Tunas Finance</title>
    <!-- Tell the browser to be responsive to screen width -->
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
    <!-- Bootstrap 3.3.5 -->
    <link rel="stylesheet" href="bootstrap/css/bootstrap.min.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="font-awesome/font-awesome.min.css">
    <!-- Ionicons -->
    <link rel="stylesheet" href="ionicons/ionicons.min.css">
    <!-- Theme style -->
    <link rel="stylesheet" href="dist/css/AdminLTE.min.css">
    <!-- AdminLTE Skins. Choose a skin from the css/skins
         folder instead of downloading all of them to reduce the load. -->
    <link rel="stylesheet" href="dist/css/skins/_all-skins.min.css">
	<link rel="stylesheet" href="plugins/select2/select2.min.css">
	
	<link rel="stylesheet" href="plugins/datatables/dataTables.bootstrap.css">
      <link href="plugins/datatables/extensions/responsive/css/datatables.responsive.css" rel="stylesheet" />
    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
        <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
	<link rel="stylesheet" href="dist/site.css">
	<link href="plugins/jQueryUItotop/ui.totop.css" rel="stylesheet" />
	<link href="chatjs/css/jquery.chatjs.css" rel="stylesheet" /> 
	<link href="plugins/datepicker/datepicker3.css" rel="stylesheet" />
      <link rel="stylesheet" type="text/css" href="highcharts/highslide.css" />
    <style>
        .form-validation-error {
            border: 1px solid #d85b5b;
            /*border-radius: 7px;*/
        }

            .form-validation-error:focus {
                outline: none;
                border-color: #f52424;
                box-shadow: 0 0 5px #f52424;
            }
    </style>

  </head>
 <body class="hold-transition skin-blue sidebar-collapse sidebar-mini fixed">
    <div class="wrapper">
    <div id="header">
        <header class="main-header">
            <!-- Logo -->
            <a class="logo">
                <!-- mini logo for sidebar mini 50x50 pixels -->
                <span class="logo-mini" style="line-height:60px;"><img src="dist/img/mtf-bg-biru.png" width="50px" /></span>
                <!-- logo for regular state and mobile devices -->
                <span class="logo-lg"><img src="dist/img/mtf-bg-biru.png" width="100px" /></span>
            </a>
            <!-- Header Navbar: style can be found in header.less -->
            <nav class="navbar navbar-static-top" role="navigation">
                <!-- Sidebar toggle button-->
                <a href="#" class="sidebar-toggle" data-toggle="offcanvas" role="button">
                    <span class="sr-only">Toggle navigation</span>
                </a>
                <div class="navbar-custom-menu pull-left" >
                    <ul class="nav navbar-nav">
                        <li>	<a id="judul-page" href="#">Detail Harga Katalog</a></li>
                    </ul>
                </div>
                <div class="navbar-custom-menu">
                    <ul id="menu-top" class="nav navbar-nav">
                        <li><a title="Tambah" href="add-eCatalogue2.html"><i class="fa fa-plus " style="font-size:20px;color:green"></i></a></li>
                    </ul>
                </div>
            </nav>
        </header>
    </div>
          <!-- Left side column. contains the logo and sidebar -->
     <div id="menu"  >
          <aside class="main-sidebar" >
            <!-- sidebar: style can be found in sidebar.less -->
             <section class="sidebar" >
			    
              <!-- sidebar menu: : style can be found in sidebar.less -->
              <ul class="sidebar-menu"  ng-controller="side-menu">
               <!-- <li class="header">MAIN NAVIGATION</li>-->
             
			    <li class="treeview" ng-repeat="menu in menus">
				    <a href="{{menu.url}}">
				        <i class="{{menu.css}}"></i> <span ng-bind="menu.menu"></span>
				    </a>				
			    </li>
              </ul>
            </section>
            <!-- /.sidebar -->
          </aside>
     </div>
    
    
      <!-- Content Wrapper. Contains page content -->
      <div class="content-wrapper">
    
		<!--<section class="content-header">-->
			<!--<h1>eCatalogue-List Item</h1>-->
		<!--</section>-->

		 <section class="content">

           <div class="row">
               <div class="col-md-10" id="section-1">
                   <!-- Default box -->
                   <div class="box box-primary box-white">
                       <div class="box-header with-border">
                           <div class="row">
                               <label id="Nama" class="col-md-9 box-title text-blue-mtf">Region</label>
                               <div class="col-md-3 pull-right">
                                   <select id="region-detail" class="form-control select2" style="width: 100%;">
                                       <!--<option value="">--Pilih--</option>-->
                                   </select>
                               </div>
                           </div>
                       </div><!-- /.box-header -->
                       <div class="box-body form-horizontal">
                           <div class="box">
                               <div class="box-body" id="section-1">
                                   <div class="row">
                                       <div class="col-md-6">
                                           <div id="hargaTerakhirMargin" style="min-height:150px;"></div>
                                           <div>
                                               <p style="text-align:center">
                                                   <b>Harga Terakhir: </b><br /><br />
                                                   <span class="label label-success" style="font-size:large"><b id="hargaCurrency"></b><b id="hargaTerakhir">Rp. 0</b> </span><br /><br />
                                                   <button class="btn btn-xs" onclick="showSpec()"><i id="tampilkanText">Tampilkan spesifikasi barang</i></button>
                                               </p>
                                           </div>
                                           <div>
                                               <table style="display:none" class="table" id="tabelSpesifikasi">
                                                   
                                               </table>
                                           </div>
                                       </div>
                                       <div class="col-md-6" id="chart-0" style="display:none;min-width: 310px; height: 400px; margin: 0 auto;border-left:1px #003BFF dashed"></div>
                                   </div>
                                   <div class="row" style="margin-top:10px">
                                       <div class="col-md-5 col-md-offset-5">
                                           <input type="button" class="btn btn-xs btn-primary" onclick="TambahHargaModal()" value="Tambah Harga Baru" />
                                       </div>
                                   </div>
                               </div>
                               <div class="box-body" id="section-2">
                                   <div class="row">
                                       <div class="col-md-12">
                                           <table id="example1" class="table table-bordered">
                                               <thead>
                                                   <tr>
                                                       <th>Date</th>
                                                       <!--<th>Label</th>-->
                                                       <th>Currency</th>
                                                       <th>Price</th>
                                                       <th>Price Source</th>
                                                       <th>User</th>
                                                       <th>Action</th>
                                                   </tr>
                                               </thead>
                                               <tbody></tbody>
                                           </table>

                                       </div>
                                   </div>
                               </div>
                           </div>
                       </div>
                   </div>
               </div>
           </div>
		</section><!-- /.content -->
    
		</div><!-- /.content-wrapper -->
        <aside class="control-sidebar control-sidebar-light control-sidebar-open">
            <ul class="nav nav-tabs nav-stacked">
                <li><a href="#section-1">Grafik Harga</a></li>
                <li><a href="#section-2">Riwayat Harga</a></li>
            </ul>
        </aside>
        <div class="control-sidebar-bg"></div> 
	   <footer class="main-footer">
        <div class="pull-right hidden-xs">
          <b>Version</b> 1.0.0
        </div>
        <strong>Supplier Relation Management</strong> 
	    </footer>
    </div><!-- ./wrapper -->
	
	<div id="HargaModal" class="modal fade" role="dialog">
	  <div class="modal-dialog">
		<input type="hidden" id="row_index" />
		<!-- Modal content-->

		<div class="modal-content">
            <form id="formTambahHarga" action="/api/Produk/TambahHarga" onsubmit="return validateFormRiwayat()" method="post">
                <input type="hidden" id="IdProduk" name="IdProduk" />
                <input type="hidden" id="id" name="id" />
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Penambahan Harga Baru</h4>
                </div>
                <div class="modal-body">

                    <div class="form-horizontal">
                        <div class="form-group">
                            <div class="row">
                                <label class="col-sm-4 control-label">Harga Baru</label>
                                <div class="col-sm-6">
                                    <!--<input name="Harga" type="number" class="form-control " placeholder="Harga">-->
                                    <input name="Harga" id="Harga" type="text" class="form-control " placeholder="Harga" onkeyup="myFunc(this.value)">
                                </div>
                            </div>
                            <div class="row" style="margin-top:5px">
                                <label class="col-sm-4 control-label">Currency</label>
                                <div class="col-sm-6">
                                    <!--<input name="Currency" type="text" maxlength="4" class="form-control " placeholder="IDR">-->
                                    <select name="Currency" class="form-control select2" style="width: 100%;">
                                    
                                    </select>
                                </div>
                            </div>
                            <div class="row" style="margin-top:5px">
                                <label class="col-sm-4 control-label">Region</label>
                                <div class="col-sm-6">
                                    <select name="Region" class="form-control select2" style="width: 100%;">
                                        <option value="">--Pilih--</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row" style="margin-top:5px">
                                <label class="col-sm-4 control-label">Sumber</label>
                                <div class="col-sm-6">
                                    <textarea name="Sumber" maxlength="500" class="form-control "></textarea>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
                <div class="modal-footer">
                    <input type="submit" value="Submit" class="btn btn-default">
                    <input type="button" class="btn btn-default" data-dismiss="modal" value="Tutup">
                </div>
            </form>
        </div>

	  </div>
	</div>
		
    <!-- jQuery 2.1.4 -->
    <script src="plugins/jQuery/jQuery-2.1.4.min.js"></script>
    <!-- Bootstrap 3.3.5 -->
    <script src="bootstrap/js/bootstrap.min.js"></script>
    <!-- SlimScroll -->
    <script src="plugins/slimScroll/jquery.slimscroll.min.js"></script>
    <!-- FastClick -->
    <script src="plugins/fastclick/fastclick.min.js"></script>
     <!-- Highcharts -->
     <script src="highcharts/highcharts.js"></script>
     <script src="highcharts/highslide-full.min.js"></script>
     <script src="highcharts/highslide.config.js" charset="utf-8"></script>
    
	 <script src="plugins/datatables/jquery.dataTables.min.js"></script>
	<script src="plugins/datatables/dataTables.bootstrap.min.js"></script>
     <script src="plugins/datatables/extensions/responsive/js/datatables.responsive.min.js"></script>
	<script src="plugins/jQueryUItotop/easing.js"></script>
	<script src="plugins/jQueryUItotop/jquery.ui.totop.js"></script>	
     <script type="text/javascript" src="site.js"></script>
     <script src="plugins/angular/angular.min.js"></script>
      <script src="dist/js/app.min.js"></script>
     <script src="dist/js/menu.js"></script>
	 <script>
	    
         var id = 0
         var jim;
         var table;

         var categories = [];
         var value = [];

         $(function () {
             var s = getParameterByName("id");
             SetListRegion();
             SetListRegionDetail(s);
             GetData();
             SetListCurrency();
             $("#region-detail").change(function () {
                 var newreg = $("#region-detail").val();
                 generateChart(s, newreg);
                 generateTable(s, newreg);
                 //$("#hargaTerakhir").html(data.Currency + " " + data.HargaTerakhir.toLocaleString('id', { minimumFractionDigits: 2 }));
             });

             $("#example1").on("click", ".edit-harga", function () {
                 
                 var data = JSON.parse($(this).attr("data"));
                 $("[name=Harga]").val(data.Harga);
                 $("#id").val(data.IdProduk);
                 $("[name=Currency]").val(data.Currency);
                 $("[name=Region]").val($("#region-detail").val());
                 $("[name=Sumber]").val(data.Sumber);
                 $("#HargaModal").modal("show");

                 
             });
         });

         function GetData() {
             var s = getParameterByName("id");
             if (s) id = s;
             if (id != 0)
                 $.ajax({
                     url: "api/produk/getdetailproduk/" + id,
                     success: function (data) {
                         $("#Nama").html(data.Nama);
                         $("#IdProduk").val(id);
                         $("#hargaCurrency").html(data.Currency);
                         $("#hargaTerakhir").html(" " + data.HargaTerakhir.toLocaleString('id', { minimumFractionDigits: 2 }));
                         generateChart(id, data.DefaultRegion);
                         generateTable(id, data.DefaultRegion);
                         $("#region-detail").val(data.DefaultRegion);
                     },
                     complete: function (xhr, textStatus) {
                         console.log(xhr.status);
                         ajaxCompleteProcess(xhr);
                     }
                 });
         }

         function generateTable(id, region) {
             //table = null;
             if (table)
                 table.destroy()

            table = $('#example1').DataTable({
                "ajax": 'api/produk/getriwayatharga2?id=' + id + '&region=' + region+'&desc=true',
                "columns": [
                    { "data": "Tanggal" },
                    { "data": "Currency" },
                    { "data": "Harga" },
                    { "data": "Sumber" },
                    { "data": "User" }
                    //{ "data": "null", "width": "3%" }
                ],
                "columnDefs": [
                {
                    "render": function (data, type, row) {
                        return '' + data.toLocaleString('id', { minimumFractionDigits: 2 });
                    },
                    "targets": 2,
                    "orderable": false
                }, {
                    "render": function (data, type, row) {
                        return "<button class='btn btn-button edit-harga' type='button' data='" + JSON.stringify(row)+ "' >edit</button>"
                    },
                    "targets": 5,
                    "orderable": false
                }],
                "paging": true,
                "lengthChange": false,
                "searching": false,
                "ordering": true,
                "info": true,
                "autoWidth": false,
                "responsive":true
            });
             if (table) table.draw();
         }
         
         function generateChart(id, region) {
             if (id)
                 $.getJSON('api/produk/getriwayatharga2?id=' + id+'&region='+region, function (data) {
                     if (data) $('#chart-0').show();
                     categories = [];
                     value = [];
                     var csv = ConvertToCSV(data.aaData);
                     console.log("wew harga: " + data.aaData[data.aaData.length - 1].Harga);
                     $("#hargaCurrency").html(data.aaData[data.aaData.length - 1].Currency);
                     $("#hargaTerakhir").html(" " + data.aaData[data.aaData.length - 1].Harga.toLocaleString('id', { minimumFractionDigits: 2 }));
                     jim = csv;
                     //console.log(data);
                     $('#chart-0').highcharts({
                         chart: {
                             type: 'spline'
                         },
                         title: {
                             text: 'Grafik Perubahan Harga'
                         },
                         subtitle: {
                             //text: 'Bata Merah Region 1'
                         },
                         xAxis: {
                             title: {
                                 text: 'Waktu'
                             },
                             categories: categories
                         },
                         yAxis: {
                             title: {
                                 text: 'Price (Rp)'
                             },
                             min: 0
                         },
                         tooltip: {
                             headerFormat: '<b>{series.name}</b><br>'
                             //pointFormat: '{point.x:%e. %b %Y}: Rp{point.y:.2f}'
                         },
                         plotOptions: {
                             spline: {
                                 marker: {
                                     enabled: true
                                 }
                             },
                             series: {
                                 cursor: 'pointer',
                                 point: {
                                     events: {
                                         click: function (e) {
                                             hs.htmlExpand(null, {
                                                 pageOrigin: {
                                                     x: e.pageX || e.clientX,
                                                     y: e.pageY || e.clientY
                                                 },
                                                 headingText: this.series.name,
                                                 maincontentText: Highcharts.dateFormat('%A, %b %e, %Y', this.x) + ':<br/> Rp' +
                                                     this.y + '<br/><b>Sumber:</b><br/><i>n/a</i>',
                                                 width: 200
                                             });
                                         }
                                     }
                                 },
                                 marker: {
                                     lineWidth: 1
                                 }
                             }
                         },

                         series: [{
                             name: 'Harga',
                             data: value
                             //    [
                             //    [Date.UTC(2016, 1, 22), 2500]
                             //]
                         }]
                     });
                 });

         }

         function TambahHargaModal() {
            $("#HargaModal").modal('show');
        }

      function ConvertToCSV(objArray) {
          var array = typeof objArray != 'object' ? JSON.parse(objArray) : objArray;
          var str = '';
          for (var i = 0; i < array.length; i++) {
              var line = '';
              for (var index in array[i]) {
                  //if (line != '' && (index == "lastUpdate" && index == "price")) line += ','
                  var ww = array[i][index];
                  if (index == "Tanggal"){
                      var s = ww.substring(0, 10);
                      line = s + "," + line;
                      categories.push(s);
                  }
                  else if (index == "Harga"){
                      line += ww;
                      value.push(ww);
                  }
                  else continue;
              }
              str += line + '\r\n';
          }
          return str;
      }

      function SetListRegion() {
          $.ajax({
              url: "/api/ReferenceData/GetAllRegion",
              success: function (data) {
                  for (var i in data) {
                      $("[name=Region]").append("<option value='" + data[i].Name + "'>" + data[i].Name + "</option>");
                  }
              },
              complete: function (xhr, textStatus) {
                  console.log(xhr.status);
                  ajaxCompleteProcess(xhr);
              }
          });
      }

      function SetListRegionDetail(id) {
          $.ajax({
              url: "/api/Produk/GetAllRegionDetail?id="+id,
              success: function (data) {
                  for (var i in data) {
                      $("#region-detail").append("<option value='" + data[i] + "'>" + data[i] + "</option>");
                  }
              },
              complete: function (xhr, textStatus) {
                  //console.log(xhr.status);
                  ajaxCompleteProcess(xhr);
              }
          });
      }

      function SetListCurrency() {
          $.ajax({
              url: "/api/ReferenceData/GetAllCurrency",
              success: function (data) {
                  for (var i in data) {
                      $("[name=Currency]").append("<option value='" + data[i].Name + "'>" + data[i].Name + "</option>");
                  }
              }
          });
      }

      var frm = $('#formTambahHarga');
      frm.submit(function (ev) {
          var v = validateForm();
          if (v) { 
              $.ajax({
                  type: frm.attr('method'),
                  url: frm.attr('action'),
                  data: frm.serialize(),
                  success: function (data) {
                      window.location.href = "catalog-detail.html?id=" + id;
                  },
                  complete: function (xhr, textStatus) {
                      console.log(xhr.status);
                      ajaxCompleteProcess(xhr);
                  }
              });
          }
          ev.preventDefault();
      });

      function validateForm() {
          var v = true;
          $('.form-validation-error').removeClass('form-validation-error');
          if ($("[name='Harga']").val() == '') {
              $("[name='Harga']").addClass('form-validation-error');
              alert("Kocak");
              v = false;
          }
          if ($("[name='Currency']").val() == '') {
              $("[name='Currency']").addClass('form-validation-error');
              v = false;
          }
          if ($("[name='Region']").val() == '') {
              $("[name='Region']").addClass('form-validation-error');
              v = false;
          }
          if ($("[name='Sumber']").val() == '') {
              $("[name='Sumber']").addClass('form-validation-error');
              v = false;
          }
          if (!v) $("form .form-validation-error").first().focus();
          return v;
      }

      function validateFormRiwayat() {
          //window.location.href="catalog-detail.html?id="+id;
          //GetData();
          return true;
      }

      function showSpec() {
          if ($("#tampilkanText").hasClass("showed")) {
              $("#tampilkanText").removeClass("showed");
              $("#hargaTerakhirMargin").slideDown({duration:800});
              $("#tampilkanText").html("Tampilkan spesifikasi barang");
              $("#tabelSpesifikasi").hide();
          }
          else {
              $("#hargaTerakhirMargin").slideUp({ duration: 100 });
              $("#tampilkanText").addClass("showed");
              $("#tampilkanText").html("Sembunyikan spesifikasi");
              $("#tabelSpesifikasi").html('');//clear table
              $.ajax({
                  url: "/api/Produk/GetKategoriSpesifikasiByProduk/" + id,
                  success: function (data) {
                      console.log(data);
                      if (data) {
                          for (var atribut in data.AtributSpesifikasi) {
                              var s = "<tr>";
                              s += '<td style="text-align:right">'+data.AtributSpesifikasi[atribut].Nama+'</td><td>:</td>' +
                                    '<td>' + data.AtributSpesifikasi[atribut].Nilai + '</td></tr>';
                              $("#tabelSpesifikasi").append(s);
                          }
                      }
                  }
              });
              $("#tabelSpesifikasi").show();
          }
      }

         //test valid

      $('#Harga').keyup(function () {
          if (this.value != this.value.replace(/[^0-9\.]/g, '')) {
              this.value = this.value.replace(/[^0-9\.]/g, '');
          }
      });
	  
    </script>
	<!-- AdminLTE App <script src="dist/js/app.min.js"></script> -->
    
  </body>
</html>
